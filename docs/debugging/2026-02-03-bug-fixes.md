# 버그 수정 기록 - 2026-02-03

## 개요

QA 테스트에서 발견된 7개의 버그를 수정한 기록입니다.

- **수정일**: 2026-02-03
- **커밋**: `64eff7b fix: resolve 7 critical bugs and add idempotency protection`
- **배포**: Vercel (https://xicon-web.vercel.app)

---

## Bug 1: 재실행 버튼 안먹힘

### 증상
- 생성 실패된 아이템의 "재시도" 버튼을 클릭해도 작동하지 않음
- 버튼 클릭 시 카드 전체가 선택되거나 다른 동작이 실행됨

### 원인 분석
`work-card.tsx`에서 버튼 클릭 이벤트가 부모 요소로 전파(event bubbling)되어 카드의 `onClick` 핸들러가 실행됨.

```typescript
// 문제 코드 (이벤트 전파 차단 없음)
<Button onClick={() => onRetry?.(item.id)}>재시도</Button>
```

### 해결
`e.stopPropagation()` 추가하여 이벤트 버블링 차단

**파일**: `/components/composed/work-card.tsx` (lines 235-249)

```typescript
// 수정된 코드
<Button
  variant="outline"
  size="sm"
  onClick={(e) => {
    e.stopPropagation();  // 이벤트 전파 차단
    onRetry?.(item.id);
  }}
>
  재시도
</Button>
```

삭제 버튼에도 동일하게 적용.

---

## Bug 2: 삭제버튼 맨 뒤에서만 작동

### 증상
- 리스트 중간에 있는 아이템 삭제 시 "삭제 실패" 토스트 표시
- 맨 뒤에서부터 삭제하면 정상 작동
- 가끔 잘못된 아이템이 삭제됨

### 원인 분석
삭제 mutation 실행 중 쿼리가 리페치되면서 배열 인덱스가 변경됨 (race condition).

```
시나리오:
1. 아이템 A, B, C 존재 (인덱스 0, 1, 2)
2. A 삭제 요청 (인덱스 0)
3. 쿼리 리페치 → B, C로 변경 (인덱스 0, 1)
4. 삭제 응답 도착 → 인덱스 0 삭제 시도
5. B가 삭제됨 (원래 A를 삭제하려 했는데)
```

### 해결
TanStack Query의 **optimistic update** 패턴 적용

**파일**:
- `/features/library/hooks/mutations/use-delete-failed-work.ts`
- `/features/library/hooks/mutations/use-move-work-to-trash.ts`

```typescript
useMutation({
  mutationFn: deleteFailedWork,

  // 1. 서버 요청 전에 UI 먼저 업데이트
  onMutate: async ({ workId }) => {
    // 진행 중인 쿼리 취소
    await queryClient.cancelQueries({ queryKey: queryKeys.works.all });

    // 이전 상태 백업
    const previousQueries = queryClient.getQueriesData({
      queryKey: queryKeys.works.all,
    });

    // 낙관적으로 아이템 제거 (ID 기반)
    queryClient.setQueriesData(
      { queryKey: queryKeys.works.all },
      (old: unknown) => {
        if (!Array.isArray(old)) return old;
        return old.filter((work: { id: string }) => work.id !== workId);
      },
    );

    return { previousQueries };
  },

  // 2. 에러 시 롤백
  onError: (_error, _variables, context) => {
    if (context?.previousQueries) {
      context.previousQueries.forEach(([queryKey, data]) => {
        queryClient.setQueryData(queryKey, data);
      });
    }
  },

  // 3. 성공 시 쿼리 무효화
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: queryKeys.works.all });
  },
});
```

### 핵심 포인트
- **인덱스 대신 ID 기반 필터링** 사용
- **낙관적 업데이트**로 race condition 방지
- **롤백 로직**으로 에러 시 복구

---

## Bug 3: 생성 콘텐츠가 라이브러리에 없음

### 증상
- 영상 생성 완료 후 라이브러리에 표시되지 않음
- 사용자가 평가(satisfaction)를 한 영상이 사라짐

### 원인 분석
`use-video-content-works.ts` 쿼리에 잘못된 필터가 있었음:

```typescript
// 문제 코드 - 완료되고 평가된 영상이 제외됨
.or("status.in.(pending,processing,failed),and(status.eq.completed,satisfaction.is.null)")
```

이 필터의 의미:
- pending, processing, failed 상태 OR
- completed이면서 satisfaction이 null인 것만 표시
- → **completed이면서 평가된(satisfaction 값 있음) 영상은 제외됨**

### 해결
잘못된 satisfaction 필터 제거

**파일**: `/features/video-content/hooks/queries/use-video-content-works.ts`

```typescript
// 수정된 코드 - 모든 영상 표시
const { data, error } = await supabase
  .from(SUPABASE_TABLES.WORKS)
  .select(SUPABASE_SELECTS.WORKS_PROMOTIONAL_HISTORY)
  .eq("project_id", projectId)
  .eq("type", "video_content")
  .eq("user_favorites.user_id", userId)
  .is("deleted_at", null)  // 삭제된 것만 제외
  .order("created_at", { ascending: false });
```

---

## Bug 4: 템플릿 생성 시간 3분→6분

### 증상
- templateId `2e8699af-da44-405d-a99a-41cb5a3bfb80` (XiCON Dance Challenge)
- 예상 생성 시간이 3분으로 표시됨
- 실제로는 6분 걸림

### 원인 분석
DB의 `templates` 테이블에서 `estimated_time` 값이 180초(3분)로 설정됨.

### 해결
SQL 마이그레이션으로 360초(6분)로 업데이트

**파일**: `/supabase/migrations/20260203120000_update_dance_template_time.sql`

```sql
-- Update XiCON Dance Challenge template estimated_time from 3 min to 6 min
UPDATE templates
SET estimated_time = 360
WHERE id = '2e8699af-da44-405d-a99a-41cb5a3bfb80';
```

---

## Bug 5: 영상 1개 생성했는데 4개 생성됨

### 증상
- 영상 생성을 1번 요청했는데 4개가 생성됨
- 라이브러리와 최근 작업 내역에 동일한 영상 4개 표시

### 원인 분석
Edge function에 **idempotency 보호가 없음**.

```
시나리오:
1. 사용자가 output_count=2로 생성 요청
2. 네트워크 지연으로 브라우저가 요청 재시도
3. 첫 번째 요청: 2개 work 생성 (batch_id=A)
4. 두 번째 요청: 2개 work 생성 (batch_id=B)
5. 결과: 4개 work 생성됨
```

### 해결
**Idempotency Key 패턴** 구현

#### 1. 클라이언트 - idempotency_key 생성

**파일**: `/features/video-content/hooks/mutations/use-generate-video-content.ts`

```typescript
const request: GenerateVideoRequest = {
  type: "video_content",
  project_id: projectId,
  template_id: templateId,
  output_count: parseInt(outputCount, 10) || 1,
  input_data: inputData,
  idempotency_key: crypto.randomUUID(),  // 고유 키 생성
};
```

#### 2. 서버 - 중복 체크

**파일**: `/supabase/functions/generate/index.ts`

```typescript
// Idempotency check (if key provided)
if (idempotency_key) {
  const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
  const { data: existingWorks } = await supabase
    .from("works")
    .select("id, batch_id")
    .eq("user_id", user.id)
    .eq("idempotency_key", idempotency_key)
    .gte("created_at", fiveMinutesAgo)
    .limit(1);

  if (existingWorks && existingWorks.length > 0) {
    // 이미 존재하면 기존 work ID 반환 (중복 생성 방지)
    return new Response(
      JSON.stringify({
        work_ids: workIds,
        batch_id: existingBatchId,
        status: "pending",
        deduplicated: true,  // 중복 요청임을 표시
      }),
      { status: 200 }
    );
  }
}
```

#### 3. DB 마이그레이션

**파일**: `/supabase/migrations/20260203130000_add_works_idempotency_key.sql`

```sql
-- Add idempotency_key column to works table
ALTER TABLE works ADD COLUMN IF NOT EXISTS idempotency_key uuid;

-- Create index for fast lookup
CREATE INDEX IF NOT EXISTS idx_works_idempotency_key
ON works(user_id, idempotency_key, created_at)
WHERE idempotency_key IS NOT NULL;
```

### Idempotency 동작 원리

```
요청 1 (idempotency_key=ABC):
  → DB 체크: ABC 없음
  → work 생성
  → idempotency_key=ABC 저장

요청 2 (같은 idempotency_key=ABC):
  → DB 체크: ABC 존재함
  → 기존 work ID 반환 (새로 생성 안함)
  → deduplicated: true
```

---

## Bug 6 & 7: 선택 안됨 + 썸네일/영상 불일치

### 증상
- Bug 6: 새로 생성된 영상(특정 templateId)만 선택 버튼이 안됨
- Bug 7: 썸네일은 맞는데 재생되는 영상이 다른 영상임

### 원인 분석
**코드는 정상**. Bug 5로 인해 생성된 **중복 데이터가 문제**.

중복 생성 시:
1. 4개의 work 레코드가 생성됨
2. n8n이 4개를 모두 처리
3. 파일 참조(`output_file_id`, `thumbnail_file_id`)가 꼬임
4. 결과: 썸네일과 영상이 서로 다른 work를 가리킴

### 해결: 수동 데이터 정리 필요

```sql
-- 1. 중복 데이터 확인
SELECT
  w.id,
  w.batch_id,
  w.created_at,
  w.status,
  w.output_file_id,
  w.thumbnail_file_id,
  f_out.file_path as output_path,
  f_thumb.file_path as thumb_path
FROM works w
LEFT JOIN files f_out ON w.output_file_id = f_out.id
LEFT JOIN files f_thumb ON w.thumbnail_file_id = f_thumb.id
WHERE w.template_id = '2e8699af-da44-405d-a99a-41cb5a3bfb80'
  AND w.type = 'video_content'
ORDER BY w.created_at DESC
LIMIT 20;

-- 2. 중복 batch 찾기
SELECT
  batch_id,
  COUNT(*),
  array_agg(id) as work_ids
FROM works
WHERE template_id = '2e8699af-da44-405d-a99a-41cb5a3bfb80'
GROUP BY batch_id
HAVING COUNT(*) > 2;

-- 3. 중복 엔트리 soft delete (필요한 것만 남기고)
-- ⚠️ 실제 삭제 전 백업 권장
UPDATE works
SET deleted_at = NOW()
WHERE id IN ('...중복된_work_ids...');
```

---

## 수정된 파일 목록

| 파일 | 변경 내용 |
|------|-----------|
| `components/composed/work-card.tsx` | e.stopPropagation() 추가 |
| `features/library/hooks/mutations/use-delete-failed-work.ts` | Optimistic update 추가 |
| `features/library/hooks/mutations/use-move-work-to-trash.ts` | Optimistic update 추가 |
| `features/video-content/hooks/queries/use-video-content-works.ts` | satisfaction 필터 제거 |
| `features/video-content/hooks/mutations/use-generate-video-content.ts` | idempotency_key 추가 |
| `features/video-content/types.ts` | idempotency_key 타입 추가 |
| `features/promotional-image/types.ts` | idempotency_key 타입 추가 |
| `features/branding-report/types.ts` | idempotency_key 타입 추가 |
| `supabase/functions/generate/index.ts` | Idempotency 체크 로직 추가 |
| `supabase/migrations/20260203120000_update_dance_template_time.sql` | 템플릿 시간 업데이트 |
| `supabase/migrations/20260203130000_add_works_idempotency_key.sql` | idempotency_key 컬럼 추가 |

---

## 테스트 파일

| 파일 | 설명 |
|------|------|
| `specs/fixtures/stealth.fixture.ts` | Chrome 자동화 감지 우회 fixture |
| `specs/bugfixes/bug-fixes-verification.spec.ts` | 4개 버그 검증 E2E 테스트 |

### 테스트 실행 방법

```bash
# 인증 설정 (최초 1회)
pnpm playwright test specs/seeds/user-auth-stealth.seed.spec.ts

# 버그 검증 테스트 실행
pnpm playwright test specs/bugfixes/bug-fixes-verification.spec.ts
```

---

## 배포

- **Git Commit**: `64eff7b`
- **Branch**: `main`
- **Push**: `origin/main`
- **Vercel**: 자동 배포 (GitHub 연동)

---

## 남은 작업

1. [ ] Supabase 마이그레이션 적용: `pnpm sb:deploy`
2. [ ] 중복 데이터 정리 (Bug 6 & 7)
3. [ ] Vercel 배포 완료 확인

---

## 참고 사항

### Idempotency Key 유효 시간
- 현재 설정: 5분
- 5분 내 동일 키로 요청 시 기존 결과 반환
- 5분 후에는 새로운 요청으로 처리

### Optimistic Update 롤백
- 서버 에러 시 자동으로 이전 상태로 복구
- 사용자에게 토스트로 에러 알림

---

*문서 작성: Claude Opus 4.5*
*작성일: 2026-02-03*
